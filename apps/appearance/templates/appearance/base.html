{% load i18n %}
{% load static %}

{% load authentication_tags %}
{% load common_tags %}
{% load navigation_tags %}
{% load smart_settings_tags %}

{% spaceless %}

<script>
    if (typeof partialNavigation === 'undefined') {
        /* Check if the template was not loaded via AJAX
         * If not then reload the root path passing the
         * current location's path as the new hash
         */
        document.write('<script type="text/undefined">')
        var currentPath = window.location.pathname + window.location.search;
        window.location = '/#' + currentPath;
    }
</script>

{% block stylesheets %}{% endblock %}

{% if appearance_type == 'plain' %}
    {% block content_plain %}{% endblock %}
{% else %}
    <div class="">
        {% navigation_resolve_menus names='facet,list facet' sort_results=True as facet_menus_link_results %}
        <div class="row zero-margin">
            <div class="col-xs-12 {% if facet_menus_link_results %}has-sidebar{% endif %}" id="viewport">
                <div class="row zero-margin">
                    <div class="col-xs-12">
                        {% common_check_sqlite as check_sqlite %}
                        {% if common_check_sqlite %}
                            <div class="alert alert-dismissible alert-warning">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                <p><strong>{% trans 'Warning' %}</strong> {{ check_sqlite }}</p>
                            </div>
                        {% endif %}
                        {% block messages %}
                        {% endblock %}

                        {% common_get_missing_items as missing_items %}

                        {% if missing_items %}
                            <div class="alert alert-warning">
                                {% for item in missing_items %}
                                    <p><strong>{{ item.label }}</strong> </p>
                                    <p>
                                        {{ item.description }}
                                        {% if item.view %}<a class="btn btn-primary" href="{% url item.view %}">{% trans 'Click here to fix this.' %}</a>{% endif %}
                                    </p>
                            {% endfor %}
                            </div>
                        {% endif %}

                        {% smart_settings_check_changed as settings_changed %}
                        {% if settings_changed %}
                            <div class="alert alert-dismissible alert-warning">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                <p><strong>{% trans 'Warning' %}</strong> {% trans 'Settings updated, restart your installation and refresh your browser for changes to take effect.' %}</p>
                            </div>
                        {% endif %}

                        {% authentication_impersonation_check as impersonated_user %}
                        {% if impersonated_user %}
                            <div class="alert alert-warning">
                                <p>
                                    {% blocktrans with impersonated_user.full_name|default:impersonated_user as user %}
                                        Impersonating user "{{ user }}".
                                    {% endblocktrans %}
                                    <a class="btn btn-primary" href="{% url 'authentication:impersonate_end' %}">{% trans 'Click here when finished' %}</a>
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {% include 'appearance/calculate_form_title.html' %}

                {# action menu #}
                {% navigation_resolve_menus names='object,secondary' sort_results=True as action_menus_link_results %}
                {% if action_menus_link_results %}
                    <div class="pull-right btn-group" id="menu-actions">
                        <button aria-expanded="true" class="btn btn-danger btn-sm dropdown-toggle" data-toggle="dropdown" type="button">
                            {% trans 'Actions' %}
                            <span class="caret"></span>
                            <span class="sr-only">{% trans 'Toggle Dropdown' %}</span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            {% for menus_link_result in action_menus_link_results %}
                                {% if action_menus_link_results|length > 1 %}
                                    <li class="dropdown-header">{{ menus_link_result.menu.label }}</li>
                                {% endif %}

                                {% for link_group in menus_link_result.link_groups %}
                                    {% if navigation_object_list %}

                                        {% ifchanged link_group.object %}
                                        {% common_get_object_verbose_name obj=link_group.object as link_group_object_verbose_name %}
                                            {% if link_group_object_verbose_name %}<li class="dropdown-header">{{ link_group_object_verbose_name }}</li>{% endif %}
                                        {% endifchanged %}
                                    {% endif %}

                                    {% with link_group.links as object_navigation_links %}
                                    {% with 'true' as as_li %}
                                    {% with 'true' as hide_active_anchor %}
                                    {% with 'btn-sm' as link_classes %}
                                        {% include 'navigation/generic_navigation.html' %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}

                                    {% if not forloop.last and link_group %}
                                        <li class="divider"></li>
                                    {% endif %}

                                {% endfor %}
                                {% if not forloop.last and menus_link_result %}
                                    <li class="divider"></li>
                                {% endif %}
                            {% endfor %}

                        </ul>
                    </div>
                    <div class="clearfix"></div>
                {% endif %}

                {% block content %}{% endblock %}
                {% block footer %}{% endblock %}
            </div>

            {% if facet_menus_link_results %}
                <div id="sidebar">
                    <div class="list-group">
                       
                        <a class="btn btn-primary btn-hotkey-default" onclick="window.location.reload();">
                            <i class="" style="padding-right: 5px; width: auto;" data-fa-i2svg=""><svg class="svg-inline--fa fa-upload fa-w-16" aria-hidden="true" data-prefix="fa" data-icon="upload" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M296 384h-80c-13.3 0-24-10.7-24-24V192h-87.7c-17.8 0-26.7-21.5-14.1-34.1L242.3 5.7c7.5-7.5 19.8-7.5 27.3 0l152.2 152.2c12.6 12.6 3.7 34.1-14.1 34.1H320v168c0 13.3-10.7 24-24 24zm216-8v112c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V376c0-13.3 10.7-24 24-24h136v8c0 30.9 25.1 56 56 56h80c30.9 0 56-25.1 56-56v-8h136c13.3 0 24 10.7 24 24zm-124 88c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20zm64 0c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20z"></path></svg></i>    
                            Upload
                        </a>        
                        <!-- {% for menu_link_result in facet_menus_link_results %}
                            {% for link_group in menu_link_result.link_groups %}
                                {% with link_group.links as object_navigation_links %}
                                {% with 'true' as hide_active_anchor %}
                                {% with 'active' as link_class_active %}
                                {% with 'list-group-item btn-sm' as link_classes %}
                                    {% include 'navigation/generic_navigation.html' %}
                                {% endwith %}
                                {% endwith %}
                                {% endwith %}
                                {% endwith %}
                            {% endfor %}
                        {% endfor %} -->
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}

<script>
    var DjangoMessages = [
        {% for message in messages %}
            {
                tags: '{{ message.tags }}',
                message: '{{ message.message }}'
            },
        {% endfor %}
    ];
    $(function () {
      $('[data-toggle="tooltip"]').tooltip();
    })
</script>
{% block javascript %}{% endblock %}

<script>
    document.title = '{% filter escapejs %}{% spaceless %}{% block title %}{% endblock %} :: {% block project_name %}{% smart_setting "COMMON_PROJECT_TITLE" %}{% endblock %}{% endspaceless %}{% endfilter %}';
    // Strip HTML entities from the title
    document.title = document.title.replace(/&(?:[a-z\d]+|#\d+|#x[a-f\d]+);/ig, '');
    afterBaseLoad();
</script>
{% endspaceless %}
